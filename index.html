for (let cv of cleanVar) {
                        for (let bv of baseVar) {
                            if (cv === bv && cv.length >= 4) return d;
                        }
                    }
                }
            }
            
            return name.toLowerCase();
        }
        
        const companies = {};
        
        rawData.forEach(row => {
            const email = (row['Buyer email'] || row['Email'] || '').trim().toLowerCase();
            const company = (row['Company'] || '').trim();
            const lower = company.toLowerCase();
            const name = `${row['First name'] || ''} ${row['Last name'] || ''}`.trim();
            
            let id = null;
            let source = '';
            
            if (!email || !email.includes('@')) {
                if (company && !excluded.includes(lower) && 
                    !lower.includes('northeastern') && 
                    !lower.includes('roux') && 
                    !lower.includes('student')) {
                    id = normalize(company);
                    source = 'Company (no email) - normalized';
                }
            } else {
                const domain = email.split('@')[1];
                if (domain === 'northeastern.edu' || domain.includes('u.northeastern')) return;
                
                if (personalEmails.includes(domain)) {
                    if (company && !excluded.includes(lower) && 
                        !lower.includes('northeastern') && 
                        !lower.includes('roux') && 
                        !lower.includes('student')) {
                        id = normalize(company);
                        source = 'Company (personal email) - normalized';
                    }
                } else {
                    id = domain;
                    source = 'Email domain';
                }
            }
            
            if (id) {
                if (!companies[id]) {
                    companies[id] = { source: source, people: [] };
                }
                companies[id].people.push({
                    name: name || 'N/A',
                    email: email || 'N/A',
                    original: company
                });
            }
        });
        
        let csv = 'Normalized Company/Domain,People Count,Source Type,Sample Persons,Original Company Names\n';
        
        Object.entries(companies)
            .sort((a, b) => b[1].people.length - a[1].people.length)
            .forEach(([id, d]) => {
                const sample = d.people.slice(0, 3).map(p => `${p.name} (${p.email})`).join('; ');
                const originals = [...new Set(d.people.map(p => p.original).filter(c => c))].join('; ');
                csv += `"${id}",${d.people.length},"${d.source}","${sample}","${originals}"\n`;
            });
        
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'unique-companies-debug.csv';
        a.click();
        URL.revokeObjectURL(url);
        alert(`Exported ${Object.keys(companies).length} unique companies with normalization details!`);
    }
</script>
</body>
</html>
