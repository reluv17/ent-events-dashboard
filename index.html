<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Roux Institute Events Dashboard</title>

<style>
/* ====== NO CHANGES TO STYLES ====== */
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:Segoe UI,Tahoma,sans-serif;background:#f5f5f5;padding:20px}
.header{background:#fff;padding:20px 40px;border-bottom:3px solid #c41230;display:flex;justify-content:space-between}
.header h1{color:#c41230}
.upload-section,.table-section{background:#fff;padding:20px 40px;margin-bottom:20px}
.metric-card{background:#fff;border:2px solid #c41230;border-radius:8px;padding:20px;text-align:center}
.metric-card.clickable{cursor:pointer}
.chart-container{background:#fff;padding:20px;border-radius:8px}
.chart-bar{background:#c41230;color:#fff;height:100%;padding-left:8px}
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5)}
.modal-content{background:#fff;margin:3% auto;width:90%;max-width:1200px}
</style>
</head>

<body>

<h1>Roux Institute Events Dashboard</h1>

<input type="file" id="fileInput">
<button id="loadButton">Load Data</button>

<div class="metrics">
  <div class="metric-card"><div id="totalRegistrations">0</div>Total Registrations</div>
  <div class="metric-card"><div id="totalAttendees">0</div>Total Attendees</div>
  <div class="metric-card"><div id="totalCompanies">0</div>Unique Companies</div>
</div>

<div id="companiesChart"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
/* ======================================================
   GLOBALS
====================================================== */
let rawData = [];

/* ======================================================
   SEEDED RANDOM — FIX #1
====================================================== */
function seededRandom(seed) {
    let x = Math.sin(seed) * 10000;
    return x - Math.floor(x);
}

/* ======================================================
   COMPANY NORMALIZATION — FIX #2
====================================================== */
function normalizeCompany(name) {
    if (!name) return null;

    let cleaned = name
        .toLowerCase()
        .trim()
        .replace(/[.,]/g, '')
        .replace(/\b(incorporated|inc|llc|ltd|corp|corporation|company|co)\b/g, '')
        .replace(/\s+/g, ' ')
        .trim();

    if (
        cleaned === '' ||
        cleaned.includes('northeastern') ||
        cleaned.includes('roux') ||
        cleaned.includes('student')
    ) {
        return null;
    }
    return cleaned;
}

/* ======================================================
   LOAD FILE
====================================================== */
document.getElementById('loadButton').onclick = function () {
    const file = document.getElementById('fileInput').files[0];
    if (!file) return alert('Select a file');

    if (file.name.endsWith('.csv')) {
        Papa.parse(file, {
            header: true,
            complete: r => { rawData = r.data; updateDashboard(); }
        });
    } else {
        const reader = new FileReader();
        reader.onload = e => {
            const wb = XLSX.read(e.target.result, { type: 'binary' });
            rawData = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
            updateDashboard();
        };
        reader.readAsBinaryString(file);
    }
};

/* ======================================================
   DASHBOARD UPDATE
====================================================== */
function updateDashboard() {
    document.getElementById('totalRegistrations').textContent = rawData.length;

    const attendance = calculateAttendance(rawData);
    document.getElementById('totalAttendees').textContent = attendance.count;

    const companies = calculateCompanies(rawData);
    document.getElementById('totalCompanies').textContent = companies.size;

    renderCompaniesChart(companies);
}

/* ======================================================
   ATTENDANCE — SEEDED & STABLE
====================================================== */
function calculateAttendance(data) {
    const eventGroups = {};
    data.forEach(r => {
        if (!eventGroups[r.Event]) eventGroups[r.Event] = [];
        eventGroups[r.Event].push(r);
    });

    const attendees = new Set();

    Object.entries(eventGroups).forEach(([eventName, rows]) => {
        const hasActual = rows.some(r => String(r.Attended).toLowerCase() === 'yes');

        if (hasActual) {
            rows.forEach(r => {
                if (String(r.Attended).toLowerCase() === 'yes') {
                    attendees.add((r['Buyer email'] || r.Email || '').toLowerCase());
                }
            });
        } else {
            const emails = [...new Set(rows.map(r =>
                (r['Buyer email'] || r.Email || '').toLowerCase()
            ))];

            const seed = eventName.split('').reduce((a,c)=>a+c.charCodeAt(0),0);
            const rate = 0.75 + seededRandom(seed) * 0.10;
            const estimated = Math.round(emails.length * rate);

            emails.slice(0, estimated).forEach(e => attendees.add(e));
        }
    });

    return { count: attendees.size };
}

/* ======================================================
   UNIQUE COMPANIES — CLEAN + DEDUPED
====================================================== */
function calculateCompanies(data) {
    const companies = new Map();

    data.forEach(r => {
        const original = (r.Company || '').trim();
        const normalized = normalizeCompany(original);
        if (!normalized) return;

        if (!companies.has(normalized)) {
            companies.set(normalized, {
                display: original,
                count: 0
            });
        }
        companies.get(normalized).count++;
    });

    return companies;
}

/* ======================================================
   COMPANY CHART
====================================================== */
function renderCompaniesChart(companies) {
    const sorted = [...companies.values()]
        .sort((a,b)=>b.count-a.count)
        .slice(0,10);

    const max = Math.max(...sorted.map(c=>c.count),1);

    document.getElementById('companiesChart').innerHTML = sorted.map(c => `
        <div style="margin:8px 0">
            <strong>${c.display}</strong>
            <div style="background:#eee">
                <div class="chart-bar" style="width:${c.count/max*100}%">${c.count}</div>
            </div>
        </div>
    `).join('');
}
</script>
</body>
</html>
