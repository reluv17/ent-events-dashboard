<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roux Institute Events Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f5f5f5; padding: 20px; }
        .header { background-color: white; padding: 20px 40px; margin-bottom: 20px; border-bottom: 3px solid #c41230; display: flex; justify-content: space-between; align-items: center; }
        .header h1 { color: #c41230; font-size: 2em; }
        .header p { color: #666; font-size: 1.1em; }
        .logo { display: flex; align-items: center; gap: 15px; }
        .logo-n { color: #c41230; font-weight: bold; font-size: 2.5em; font-family: Georgia, serif; cursor: pointer; user-select: none; }
        .logo-text { display: flex; flex-direction: column; line-height: 1.3; }
        .logo-text .institute { color: #c41230; font-size: 1.2em; font-weight: 700; }
        .logo-text .university { color: #666; font-size: 0.95em; }
        .upload-section { background-color: white; padding: 20px 40px; margin-bottom: 20px; border: 2px dashed #c41230; text-align: center; }
        .upload-section h3 { margin-bottom: 15px; color: #333; }
        .upload-controls { display: flex; justify-content: center; gap: 15px; align-items: center; }
        #fileInput { padding: 10px; }
        #loadButton { background-color: #c41230; color: white; border: none; padding: 12px 30px; font-size: 1em; cursor: pointer; border-radius: 4px; font-weight: bold; }
        #loadButton:hover { background-color: #a00f28; }
        .filters { display: flex; gap: 20px; margin-bottom: 20px; padding: 0 40px; }
        select { padding: 12px 20px; font-size: 1em; border: 2px solid #c41230; border-radius: 4px; background-color: white; cursor: pointer; }
        .metrics { display: grid; grid-template-columns: repeat(7, 1fr); gap: 20px; margin-bottom: 30px; padding: 0 40px; }
        .metric-card { background-color: white; padding: 30px; text-align: center; border: 2px solid #c41230; border-radius: 8px; }
        .metric-card.clickable { cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; }
        .metric-card.clickable:hover { transform: translateY(-5px); box-shadow: 0 4px 8px rgba(196, 18, 48, 0.3); }
        .metric-value { font-size: 3em; font-weight: bold; color: #333; margin-bottom: 10px; }
        .metric-label { color: #666; font-size: 1em; }
        .charts-section { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 30px; padding: 0 40px; }
        .chart-container { background-color: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .chart-title { font-size: 1.3em; font-weight: 600; color: #333; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #c41230; }
        .stats-summary-inline { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px; }
        .stat-box-inline { background-color: #f5f5f5; padding: 15px; border-radius: 4px; text-align: center; }
        .stat-box-inline .value { font-size: 1.8em; font-weight: bold; color: #c41230; }
        .stat-box-inline .label { font-size: 0.85em; color: #666; margin-top: 5px; }
        .table-section { background-color: white; padding: 30px 40px; margin: 0 40px; }
        .table-section h2 { background-color: #c41230; color: white; padding: 15px 20px; margin: -30px -40px 20px -40px; }
        table { width: 100%; border-collapse: collapse; }
        th { background-color: #c41230; color: white; padding: 15px; text-align: left; font-weight: 600; }
        td { padding: 15px; border-bottom: 1px solid #ddd; }
        tr:nth-child(even) { background-color: #f9f9f9; }
        tr:hover { background-color: #f0f0f0; }
        .status-message { text-align: center; padding: 20px; color: #666; font-style: italic; }
        .chart-item { display: flex; align-items: center; margin-bottom: 15px; }
        .chart-label { width: 200px; font-weight: 500; }
        .chart-bar-container { flex: 1; background-color: #f0f0f0; height: 30px; border-radius: 4px; overflow: hidden; position: relative; }
        .chart-bar { background-color: #c41230; height: 100%; display: flex; align-items: center; padding-left: 10px; color: white; font-weight: bold; transition: width 0.3s ease; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: white; margin: 3% auto; padding: 0; border-radius: 8px; width: 90%; max-width: 1200px; max-height: 85vh; display: flex; flex-direction: column; }
        .modal-header { background-color: #c41230; color: white; padding: 20px 30px; border-radius: 8px 8px 0 0; display: flex; justify-content: space-between; align-items: center; }
        .modal-header h2 { margin: 0; font-size: 1.5em; }
        .close { color: white; font-size: 35px; font-weight: bold; cursor: pointer; line-height: 1; }
        .close:hover { opacity: 0.8; }
        .modal-body { padding: 30px; overflow-y: auto; flex: 1; }
        .modal-search { margin-bottom: 20px; display: flex; gap: 10px; align-items: center; }
        .modal-search input { flex: 1; padding: 10px; border: 2px solid #c41230; border-radius: 4px; font-size: 1em; }
        .modal-export-btn, .modal-debug-btn { color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .modal-export-btn { background-color: #c41230; }
        .modal-export-btn:hover { background-color: #a00f28; }
        .modal-debug-btn { background-color: #6c757d; }
        .modal-debug-btn:hover { background-color: #5a6268; }
        .modal-table { width: 100%; border-collapse: collapse; }
        .modal-table th { background-color: #c41230; color: white; padding: 12px; text-align: left; font-weight: 600; position: sticky; top: 0; }
        .modal-table td { padding: 12px; border-bottom: 1px solid #ddd; }
        .modal-table tr:nth-child(even) { background-color: #f9f9f9; }
        .modal-table tr:hover { background-color: #f0f0f0; }
        .company-group { margin-bottom: 30px; border: 1px solid #ddd; border-radius: 4px; overflow: hidden; }
        .company-group-header { background-color: #f5f5f5; padding: 15px; font-weight: bold; color: #333; border-bottom: 2px solid #c41230; }
        .company-group-body { padding: 15px; }
    </style>
</head>
<body>
    <div class="header">
        <div>
            <h1>Roux Institute Events Dashboard</h1>
            <p>Event Analytics & Attendance Tracking</p>
        </div>
        <div class="logo">
            <div class="logo-n" id="debugTrigger">N</div>
            <div class="logo-text">
                <span class="institute">The Roux Institute</span>
                <span class="university">Northeastern University</span>
            </div>
        </div>
    </div>
    <div class="upload-section">
        <h3><strong>Update Dashboard Data:</strong> Upload your event registration CSV or Excel file</h3>
        <div class="upload-controls">
            <input type="file" id="fileInput" accept=".csv,.xlsx,.xls">
            <button id="loadButton">Load Event Data</button>
        </div>
    </div>
    <div class="filters">
        <select id="eventFilter"><option value="All">All Events</option></select>
    </div>
    <div class="metrics">
        <div class="metric-card">
            <div class="metric-value" id="totalRegistrations">0</div>
            <div class="metric-label">Total Registrations</div>
        </div>
        <div class="metric-card clickable" onclick="openModal('uniqueRegistrants')">
            <div class="metric-value" id="uniqueRegistrants">0</div>
            <div class="metric-label">Unique Registrants</div>
        </div>
        <div class="metric-card clickable" onclick="openModal('attendees')">
            <div class="metric-value" id="totalAttendees">0</div>
            <div class="metric-label">Total Attendees</div>
        </div>
        <div class="metric-card clickable" onclick="openModal('companies')">
            <div class="metric-value" id="totalCompanies">0</div>
            <div class="metric-label">Unique Companies</div>
        </div>
        <div class="metric-card clickable" onclick="openModal('govt')">
            <div class="metric-value" id="totalGovt">0</div>
            <div class="metric-label">Gov't Institutions</div>
        </div>
        <div class="metric-card clickable" onclick="openModal('students')">
            <div class="metric-value" id="rouxStudents">0</div>
            <div class="metric-label">Roux Students</div>
        </div>
        <div class="metric-card clickable" onclick="openModal('staff')">
            <div class="metric-value" id="totalNortheastern">0</div>
            <div class="metric-label">Northeastern/Roux Staff</div>
        </div>
    </div>
    <div class="charts-section">
        <div class="chart-container">
            <div class="chart-title">Top 10 Companies by Registrations</div>
            <div id="companiesChart"></div>
        </div>
        <div class="chart-container">
            <div class="chart-title">Attendee Type Breakdown</div>
            <canvas id="attendeeTypeChart" height="250"></canvas>
        </div>
        <div class="chart-container">
            <div class="chart-title">Event Comparison</div>
            <canvas id="eventComparisonChart" height="250"></canvas>
        </div>
        <div class="chart-container">
            <div class="chart-title">Event Participation Distribution</div>
            <div class="stats-summary-inline">
                <div class="stat-box-inline"><div class="value" id="statTotalPeople">0</div><div class="label">Unique Registrants</div></div>
                <div class="stat-box-inline"><div class="value" id="statAvgEvents">0</div><div class="label">Avg Events/Person</div></div>
                <div class="stat-box-inline"><div class="value" id="statMaxEvents">0</div><div class="label">Max Events</div></div>
            </div>
            <canvas id="participationChart" height="200"></canvas>
        </div>
        <div class="chart-container" id="multiDayContainer" style="display: none;">
            <div class="chart-title" id="multiDayTitle">Attendance by Event Day</div>
            <div id="multiDayChart"></div>
        </div>
    </div>
    <div class="table-section">
        <h2>Event Attendee Details</h2>
        <div style="margin-bottom: 20px;">
            <input type="text" id="searchInput" placeholder="Search by name, company, or email..." style="width: 100%; padding: 12px; font-size: 1em; border: 2px solid #c41230; border-radius: 4px;">
        </div>
        <div id="tableContainer">
            <div class="status-message">Please upload a CSV file to view event data</div>
        </div>
    </div>
    <div id="detailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Details</h2>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="modal-search">
                    <input type="text" id="modalSearch" placeholder="Search...">
                    <button class="modal-export-btn" onclick="exportModalData()">Export to CSV</button>
                    <button class="modal-debug-btn" id="debugBtn" onclick="exportCompanyDebug()" style="display:none;">Debug Export</button>
                </div>
                <div id="modalContent"></div>
            </div>
        </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script>
let rawData=[];let attendeeTypeChart=null;let eventComparisonChart=null;let participationChart=null;let currentModalData=[];let currentModalType='';window.addEventListener('DOMContentLoaded',function(){const saved=localStorage.getItem('rouxEventsData');if(saved){try{rawData=JSON.parse(saved);processData()}catch(e){console.error(e)}}});document.getElementById('loadButton').addEventListener('click',loadFile);function loadFile(){const input=document.getElementById('fileInput');const file=input.files[0];if(!file){alert('Please select a file first');return}const reader=new FileReader();const name=file.name.toLowerCase();if(name.endsWith('.csv')){reader.onload=function(e){Papa.parse(e.target.result,{header:true,skipEmptyLines:true,complete:function(r){rawData=r.data;saveData();processData()}})};reader.readAsText(file)}else if(name.endsWith('.xlsx')||name.endsWith('.xls')){reader.onload=function(e){const wb=XLSX.read(e.target.result,{type:'binary'});rawData=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);saveData();processData()};reader.readAsBinaryString(file)}}function saveData(){try{localStorage.setItem('rouxEventsData',JSON.stringify(rawData))}catch(e){console.error(e)}}function processData(){populateFilters();updateDashboard()}function populateFilters(){const f=document.getElementById('eventFilter');const events=[...new Set(rawData.map(r=>r['Event']).filter(e=>e))];f.innerHTML='<option value="All">All Events</option>';events.forEach(e=>f.appendChild(new Option(e,e)))}function getFilteredData(){const f=document.getElementById('eventFilter').value;let filtered=rawData.filter(r=>r['Event']);if(f!=='All')filtered=filtered.filter(r=>r['Event']===f);return filtered}function updateDashboard(){const filtered=getFilteredData();document.getElementById('totalRegistrations').textContent=filtered.length;const emails=[...new Set(filtered.map(r=>(r['Buyer email']||r['Email']||'').trim().toLowerCase()).filter(e=>e))];document.getElementById('uniqueRegistrants').textContent=emails.length;const att=calculateAttendance(filtered);document.getElementById('totalAttendees').textContent=Math.round(att.count);const m=calculateMetrics(filtered);document.getElementById('totalCompanies').textContent=m.companies;document.getElementById('totalGovt').textContent=m.govt;document.getElementById('rouxStudents').textContent=m.students;document.getElementById('totalNortheastern').textContent=m.staff;updateCompaniesChart(filtered);updateAttendeeTypeChart(filtered);updateEventComparisonChart(filtered);updateParticipationChart(filtered);updateMultiDayChart(filtered);renderTable(filtered)}function updateParticipationChart(data){const people={};data.forEach(r=>{const e=(r['Buyer email']||r['Email']||'').trim().toLowerCase();if(e){if(!people[e])people[e]=new Set();people[e].add(r['Event'])}});const hist={};Object.values(people).forEach(events=>{const c=events.size;hist[c]=(hist[c]||0)+1});const counts=Object.values(people).map(e=>e.size);const total=counts.length;const avg=total>0?(counts.reduce((a,b)=>a+b,0)/total).toFixed(1):0;const max=total>0?Math.max(...counts):0;document.getElementById('statTotalPeople').textContent=total;document.getElementById('statAvgEvents').textContent=avg;document.getElementById('statMaxEvents').textContent=max;const labels=Object.keys(hist).sort((a,b)=>a-b);const vals=labels.map(l=>hist[l]);const ctx=document.getElementById('participationChart');if(participationChart)participationChart.destroy();participationChart=new Chart(ctx,{type:'bar',data:{labels:labels.map(l=>`${l} ${l==='1'?'event':'events'}`),datasets:[{label:'Number of People',data:vals,backgroundColor:'#c41230'}]},options:{responsive:true,maintainAspectRatio:true,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true,ticks:{stepSize:1}}}}})}function calculateAttendance(data){const groups={};data.forEach(r=>{const e=r['Event']||'Unknown';if(!groups[e])groups[e]=[];groups[e].push(r)});const attended=new Set();Object.values(groups).forEach(ev=>{const has=ev.some(r=>{const v=r['Attended'];return v&&(v.toString().toLowerCase()==='yes'||v.toString()==='1')});if(has){ev.forEach(r=>{const v=r['Attended'];if(v&&(v.toString().toLowerCase()==='yes'||v.toString()==='1')){const em=(r['Buyer email']||r['Email']||'').trim().toLowerCase();if(em)attended.add(em)}})}else{const ems=[...new Set(ev.map(r=>(r['Buyer email']||r['Email']||'').trim().toLowerCase()).filter(e=>e))];const est=Math.round(ems.length*0.8);ems.slice(0,est).forEach(e=>attended.add(e))}});return{count:attended.size}}function calculateMetrics(data){const pers=['gmail.com','yahoo.com','outlook.com','hotmail.com','icloud.com','me.com','aol.com','mail.com'];const excl=['retired','independent','na','n/a','self','?','none','student'];const doms={};data.forEach(r=>{const em=(r['Buyer email']||r['Email']||'').trim().toLowerCase();if(em&&em.includes('@')){const d=em.split('@')[1];if(d&&d!=='northeastern.edu'&&!pers.includes(d)&&!d.includes('u.northeastern')&&d.split('.').length>=2&&d.length>5){doms[d]=d}}});function norm(n){if(!n)return null;let cl=n.toLowerCase().replace(/\s+/g,'').replace(/[,\.\'\"]/g,'').replace(/\b(llc|inc|ltd|co|corp|corporation|company|group|the)\b/g,'').trim();for(let d of Object.keys(doms)){const b=d.split('.')[0];if(cl===b)return d;if(b.length>=4&&cl.length>=4){const cv=[cl,cl+'s',cl.replace(/s$/,'')];const bv=[b,b+'s',b.replace(/s$/,'')];for(let c of cv){for(let v of bv){if(c===v&&c.length>=4)return d}}}}return n.toLowerCase()}const comps=new Set();data.forEach(r=>{const em=(r['Buyer email']||r['Email']||'').trim().toLowerCase();const co=(r['Company']||'').trim();const low=co.toLowerCase();let id=null;if(!em||!em.includes('@')){if(co&&!excl.includes(low)&&!low.includes('northeastern')&&!low.includes('roux')&&!low.includes('student')){id=norm(co)}}else{const d=em.split('@')[1];if(d==='northeastern.edu'||d.includes('u.northeastern'))return;if(pers.includes(d)){if(co&&!excl.includes(low)&&!low.includes('northeastern')&&!low.includes('roux')&&!low.includes('student')){id=norm(co)}}else{id=d}}if(id)comps.add(id)});const gov=data.filter(r=>{const c=(r['Company']||'').toLowerCase();const e=(r['Buyer email']||r['Email']||'').toLowerCase();return c.includes('town of')||c.includes('city of')||c.includes('county')||e.includes('.gov')||c.includes('government')||c.includes('municipal')}).length;const stud=data.filter(r=>{const em=(r['Buyer email']||r['Email']||'').toLowerCase();const co=(r['Company']||'').toLowerCase();const pat=/^[a-z]{3,}\.[a-z]{1,3}@northeastern\.edu$/;if(pat.test(em))return true;const d=em.includes('@')?em.split('@')[1]:'';return pers.includes(d)&&(co==='student'||co.includes('student')||co.includes('northeastern')||co.includes('roux'))}).length;const sta=data.filter(r=>{const em=(r['Buyer email']||r['Email']||'').toLowerCase();const sp=/^[a-z]{1,3}\.[a-z]{3,}@northeastern\.edu$/;const st=/^[a-z]{3,}\.[a-z]{1,3}@northeastern\.edu$/;return em.includes('northeastern.edu')&&(sp.test(em)||!st.test(em))}).length;return{companies:comps.size,govt:gov,students:stud,staff:sta}}function openModal(type){if(rawData.length===0){alert('Please upload data first');return}currentModalType=type;const m=document.getElementById('detailModal');const f=getFilteredData();document.getElementById('debugBtn').style.display=(type==='companies')?'block':'none';let t='';let c='';switch(type){case 'uniqueRegistrants':t='Unique Registrants Details';c=genUniqueReg(f);break;case 'attendees':t='Total Attendees Details';c=genAtt(f);break;case 'companies':t='Unique Companies Details';c=genComp(f);break;case 'govt':t='Government Institutions Details';c=genGov(f);break;case 'students':t='Roux Students Details';c=genStud(f);break;case 'staff':t='Northeastern/Roux Staff Details';c=genStaff(f);break}document.getElementById('modalTitle').textContent=t;document.getElementById('modalContent').innerHTML=c;m.style.display='block'}function closeModal(){document.getElementById('detailModal').style.display='none'}window.onclick=function(e){if(e.target==document.getElementById('detailModal'))closeModal()};function genUniqueReg(data){const u={};data.forEach(r=>{const em=(r['Buyer email']||r['Email']||'').trim().toLowerCase();if(em){if(!u[em]){u[em]={name:`${r['First name']||''} ${r['Last name']||''}`.trim(),email:em,company:r['Company']||'N/A',events:[]}}u[em].events.push(r['Event'])}});currentModalData=Object.values(u);let h='<table class="modal-table"><thead><tr><th>Name</th><th>Email</th><th>Company</th><th>Events Registered</th></tr></thead><tbody>';currentModalData.forEach(p=>{h+=`<tr><td>${p.name||'N/A'}</td><td>${p.email}</td><td>${p.company}</td><td>${[...new Set(p.events)].join(', ')}</td></tr>`});return h+'</tbody></table>'}function genAtt(data){const gr={};data.forEach(r=>{const e=r['Event']||'Unknown';if(!gr[e])gr[e]=[];gr[e].push(r)});const att={};Object.entries(gr).forEach(([en,ed])=>{const has=ed.some(r=>{const v=r['Attended'];return v&&(v.toString().toLowerCase()==='yes'||v.toString()==='1')});if(has){ed.forEach(r=>{const v=r['Attended'];if(v&&(v.toString().toLowerCase()==='yes'||v.toString()==='1')){const em=(r['Buyer email']||r['Email']||'').trim().toLowerCase();if(em){if(!att[em]){att[em]={name:`${r['First name']||''} ${r['Last name']||''}`.trim(),email:em,company:r['Company']||'N/A',events:[]}}att[em].events.push(en)}}})}else{const ems={};ed.forEach(r=>{const e=(r['Buyer email']||r['Email']||'').trim().toLowerCase();if(e&&!ems[e]){ems[e]={name:`${r['First name']||''} ${r['Last name']||''}`.trim(),company:r['Company']||'N/A'}}});const el=Object.keys(ems);const est=Math.round(el.length*0.8);el.slice(0,est).forEach(e=>{if(!att[e]){att[e]={name:ems[e].name,email:e,company:ems[e].company,events:[]}}att[e].events.push(en+' (est.)')})}});currentModalData=Object.values(att);let h='<table class="modal-table"><thead><tr><th>Name</th><th>Email</th><th>Company</th><th>Events Attended</th></tr></thead><tbody>';currentModalData.forEach(p=>{h+=`<tr><td>${p.name||'N/A'}</td><td>${p.email}</td><td>${p.company}</td><td>${p.events.join(', ')}</td></tr>`});return h+'</tbody></table>'}function genComp(data){const pers=['gmail.com','yahoo.com','outlook.com','hotmail.com','icloud.com','me.com','aol.com','mail.com'];const excl=['retired','independent','na','n/a','self','?','none','student'];const doms={};data.forEach(r=>{const em=(r['Buyer email']||r['Email']||'').trim().toLowerCase();if(em&&em.includes('@')){const d=em.split('@')[1];if(d&&d!=='northeastern.edu'&&!pers.includes(d)&&!d.includes('u.northeastern')&&d.split('.').length>=2&&d.length>5){doms[d]=d}}});function norm(n){if(!n)return null;let cl=n.toLowerCase().replace(/\s+/g,'').replace(/[,\.\'\"]/g,'').replace(/\b(llc|inc|ltd|co|corp|corporation|company|group|the)\b/g,'').trim();for(let d of Object.keys(doms)){const b=d.split('.')[0];if(cl===b)return d;if(b.length>=4&&cl.length>=4){const cv=[cl,cl+'s',cl.replace(/s$/,'')];const bv=[b,b+'s',b.replace(/s$/,'')];for(let c of cv){for(let v of bv){if(c===v&&c.length>=4)return d}}}}return n.toLowerCase()}const comps={};data.forEach(r=>{const em=(r['Buyer email']||r['Email']||'').trim().toLowerCase();const co=(r['Company']||'').trim();const low=co.toLowerCase();let id=null;if(!em||!em.includes('@')){if(co&&!excl.includes(low)&&!low.includes('northeastern')&&!low.includes('roux')&&!low.includes('student')){id=norm(co)}}else{const d=em.split('@')[1];if(d==='northeastern.edu'||d.includes('u.northeastern'))return;if(pers.includes(d)){if(co&&!excl.includes(low)&&!low.includes('northeastern')&&!low.includes('roux')&&!low.includes('student')){id=norm(co)}}else{id=d}}if(id){if(!comps[id]){comps[id]={name:co||id,people:[]}}const nm=`${r['First name']||''} ${r['Last name']||''}`.trim();const pe=em||'N/A';const ex=comps[id].people.some(p=>p.email===pe);if(!ex){comps[id].people.push({name:nm,email:pe})}}});currentModalData=Object.entries(comps).map(([id,d])=>({company:d.name,count:d.people.length,people:d.people})).sort((a,b)=>b.count-a.count);let h='';currentModalData.forEach(c=>{h+=`<div class="company-group"><div class="company-group-header">${c.company} (${c.count} ${c.count===1?'person':'people'})</div><div class="company-group-body"><table class="modal-table"><thead><tr><th>Name</th><th>Email</th></tr></thead><tbody>`;c.people.forEach(p=>{h+=`<tr><td>${p.name||'N/A'}</td><td>${p.email}</td></tr>`});h+=`</tbody></table></div></div>`});return h}function genGov(data){const gov=data.filter(r=>{const c=(r['Company']||'').toLowerCase();const e=(r['Buyer email']||r['Email']||'').toLowerCase();return c.includes('town of')||c.includes('city of')||c.includes('county')||e.includes('.gov')||c.includes('government')||c.includes('municipal')});const u={};gov.forEach(r=>{const em=(r['Buyer email']||r['Email']||'').trim().toLowerCase();if(em){if(!u[em]){u[em]={name:`${r['First name']||''} ${r['Last name']||''}`.trim(),email:em,company:r['Company']||'N/A',events:[]}}u[em].events.push(r['Event'])}});currentModalData=Object.values(u);let h='<table class="modal-table"><thead><tr><th>Name</th><th>Email</th><th>Institution</th><th>Events</th></tr></thead><tbody>';currentModalData.forEach(p=>{h+=`<tr><td>${p.name||'N/A'}</td><td>${p.email}</td><td>${p.company}</td><td>${[...new Set(p.events)].join(', ')}</td></tr>`});return h+'</tbody></table>'}function genStud(data){const pers=['gmail.com','yahoo.com','outlook.com','hotmail.com','icloud.com','me.com','aol.com','mail.com'];const stud=data.filter(r=>{const em=(r['Buyer email']||r['Email']||'').toLowerCase();const co=(r['Company']||'').toLowerCase();const pat=/^[a-z]{3,}\.[a-z]{1,3}@northeastern\.edu$/;if(pat.test(em))return true;const d=em.includes('@')?em.split('@')[1]:'';return pers.includes(d)&&(co==='student'||co.includes('student')||co.includes('northeastern')||co.includes('roux'))});const u={};stud.forEach(r=>{const em=(r['Buyer email']||r['Email']||'').trim().toLowerCase();if(em){if(!u[em]){const pat=/^[a-z]{3,}\.[a-z]{1,3}@northeastern\.edu$/;u[em]={name:`${r['First name']||''} ${r['Last name']||''}`.trim(),email:em,method:pat.test(em)?'Student email pattern':'Personal email + Company',events:[]}}u[em].events.push(r['Event'])}});currentModalData=Object.values(u);let h='<table class="modal-table"><thead><tr><th>Name</th><th>Email</th><th>Detection Method</th><th>Events</th></tr></thead><tbody>';currentModalData.forEach(p=>{h+=`<tr><td>${p.name||'N/A'}</td><td>${p.email}</td><td>${p.method}</td><td>${[...new Set(p.events)].join(', ')}</td></tr>`});return h+'</tbody></table>'}function genStaff(data){const staff=data.filter(r=>{const em=(r['Buyer email']||r['Email']||'').toLowerCase();const sp=/^[a-z]{1,3}\.[a-z]{3,}@northeastern\.edu$/;const st=/^[a-z]{3,}\.[a-z]{1,3}@northeastern\.edu$/;return em.includes('northeastern.edu')&&(sp.test(em)||!st.test(em))});const u={};staff.forEach(r=>{const em=(r['Buyer email']||r['Email']||'').trim().toLowerCase();if(em){if(!u[em]){u[em]={name:`${r['First name']||''} ${r['Last name']||''}`.trim(),email:em,events:[]}}u[em].events.push(r['Event'])}});currentModalData=Object.values(u);let h='<table class="modal-table"><thead><tr><th>Name</th><th>Email</th><th>Events</th></tr></thead><tbody>';currentModalData.forEach(p=>{h+=`<tr><td>${p.name||'N/A'}</td><td>${p.email}</td><td>${[...new Set(p.events)].join(', ')}</td></tr>`});return h+'</tbody></table>'}document.getElementById('modalSearch').addEventListener('input',function(){const t=this.value.toLowerCase();const rows=document.querySelectorAll('.modal-table tbody tr, .company-group');rows.forEach(r=>{r.style.display=r.textContent.toLowerCase().includes(t)?'':'none'})});function exportModalData(){let csv='';if(currentModalType==='companies'){csv='Company,Count,People\n';currentModalData.forEach(i=>{const p=i.people.map(p=>`${p.name} (${p.email})`).join('; ');csv+=`"${i.company}",${i.count},"${p}"\n`})}else{csv='Name,Email,Company/Method,Events\n';currentModalData.forEach(i=>{const e=[...new Set(i.events||[])].join('; ');csv+=`"${i.name}","${i.email}","${i.company||i.method||'N/A'}","${e}"\n`})}const b=new Blob([csv],{type:'text/csv'});const u=URL.createObjectURL(b);const a=document.createElement('a');a.href=u;a.download=`${currentModalType}-details.csv`;a.click();URL.revokeObjectURL(u)}function updateCompaniesChart(data){const c={};data.forEach(r=>{const co=(r['Company']||'').trim();const l=co.toLowerCase();if(!co||l.includes('northeastern')||l.includes('roux')||l==='student'||l.includes('student'))return;c[co]=(c[co]||0)+1});const s=Object.entries(c).sort((a,b)=>b[1]-a[1]).slice(0,10);const con=document.getElementById('companiesChart');if(s.length===0){con.innerHTML='<div class="status-message">No external company data available</div>';return}const mx=Math.max(...s.map(i=>i[1]));con.innerHTML=s.map(([co,n])=>`<div class="chart-item"><div class="chart-label">${co}</div><div class="chart-bar-container"><div class="chart-bar" style="width:${(n/mx)*100}%">${n}</div></div></div>`).join('')}function updateAttendeeTypeChart(data){const pers=['gmail.com','yahoo.com','outlook.com','hotmail.com','icloud.com','me.com','aol.com','mail.com'];const stud=data.filter(r=>{const em=(r['Buyer email']||r['Email']||'').toLowerCase();const co=(r['Company']||'').toLowerCase();const pat=/^[a-z]{3,}\.[a-z]{1,3}@northeastern\.edu$/;if(pat.test(em))return true;const d=em.includes('@')?em.split('@')[1]:'';return pers.includes(d)&&(co==='student'||co.includes('student')||co.includes('northeastern')||co.includes('roux'))}).length;const staff=data.filter(r=>{const em=(r['Buyer email']||r['Email']||'').toLowerCase();const sp=/^[a-z]{1,3}\.[a-z]{3,}@northeastern\.edu$/;const st=/^[a-z]{3,}\.[a-z]{1,3}@northeastern\.edu$/;return em.includes('northeastern.edu')&&(sp.test(em)||!st.test(em))}).length;const gov=data.filter(r=>{const c=(r['Company']||'').toLowerCase();const e=(r['Buyer email']||r['Email']||'').toLowerCase();return c.includes('town of')||c.includes('city of')||c.includes('county')||e.includes('.gov')||c.includes('government')||c.includes('municipal')}).length;const oth=data.length-stud-staff-gov;const ctx=document.getElementById('attendeeTypeChart');if(attendeeTypeChart)attendeeTypeChart.destroy();attendeeTypeChart=new Chart(ctx,{type:'doughnut',data:{labels:['Roux Students','Northeastern/Roux Staff','Gov\'t Institutions','Other Companies'],datasets:[{data:[stud,staff,gov,oth],backgroundColor:['#c41230','#f59e0b','#4a90e2','#95a5a6']}]},options:{responsive:true,maintainAspectRatio:true,plugins:{legend:{position:'bottom'}}}})}function updateEventComparisonChart(data){const c={};data.forEach(r=>{const e=r['Event']||'Unknown';c[e]=(c[e]||0)+1});const s=Object.entries(c).sort((a,b)=>b[1]-a[1]);const ctx=document.getElementById('eventComparisonChart');if(eventComparisonChart)eventComparisonChart.destroy();eventComparisonChart=new Chart(ctx,{type:'bar',data:{labels:s.map(i=>i[0]),datasets:[{label:'Registrations',data:s.map(i=>i[1]),backgroundColor:'#c41230'}]},options:{responsive:true,maintainAspectRatio:true,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true,ticks:{stepSize:1}}}}})}function updateMultiDayChart(data){const con=document.getElementById('multiDayContainer');const f=document.getElementById('eventFilter').value;if(f==='All'||!data.some(r=>r['Which days do you plan to attend?'])){con.style.display='none';return}con.style.display='block';document.getElementById('multiDayTitle').textContent=`Attendance by Event Day - ${f}`;const c={};data.forEach(r=>{const d=r['Which days do you plan to attend?'];if(d&&d.trim()){c[d.trim()]=(c[d.trim()]||0)+1}});const mx=Math.max(...Object.values(c),1);document.getElementById('multiDayChart').innerHTML=Object.entries(c).sort((a,b)=>b[1]-a[1]).map(([d,n])=>`<div class="chart-item"><div class="chart-label">${d}</div><div class="chart-bar-container"><div class="chart-bar" style="width:${(n/mx)*100}%">${n}</div></div></div>`).join('')}function renderTable(data){const con=document.getElementById('tableContainer');if(data.length===0){con.innerHTML='<div class="status-message">No data available</div>';return}const has=data.some(r=>r.hasOwnProperty('Attended'));let h='<table><thead><tr><th>Name</th><th>Company</th><th>Email</th><th>Registration Date</th><th>Event</th>';if(has)h+='<th>Attended</th>';h+='<th>Days Attending</th></tr></thead><tbody>';data.forEach(r=>{const nm=`${r['First name']||''} ${r['Last name']||''}`.trim();h+=`<tr><td>${nm||'N/A'}</td><td>${r['Company']||'N/A'}</td><td>${r['Buyer email']||r['Email']||'N/A'}</td><td>${r['Order date & time']||r['Registration Date']||'N/A'}</td><td>${r['Event']||'N/A'}</td>`;if(has)h+=`<td>${r['Attended']||'N/A'}</td>`;h+=`<td>${r['Which days do you plan to attend?']||'N/A'}</td></tr>`});con.innerHTML=h+'</tbody></table>'}document.getElementById('eventFilter').addEventListener('change',updateDashboard);document.getElementById('searchInput').addEventListener('input',function(e){const t=e.target.value.toLowerCase();const rows=document.querySelectorAll('#tableContainer tbody tr');rows.forEach(r=>{r.style.display=r.textContent.toLowerCase().includes(t)?'':'none'})});let nc=0;let nt=null;document.getElementById('debugTrigger').addEventListener('click',function(){nc++;if(nc===3){exportCategorization();nc=0;clearTimeout(nt)}if(nt)clearTimeout(nt);nt=setTimeout(()=>nc=0,1000)});function exportCategorization(){if(rawData.length===0)return;const pers=['gmail.com','yahoo.com','outlook.com','hotmail.com','icloud.com','me.com','aol.com','mail.com'];let csv='Name,Email,Company,Category,Detection Method\n';rawData.forEach(r=>{const nm=`${r['First name']||''} ${r['Last name']||''}`.trim();const em=(r['Buyer email']||r['Email']||'').toLowerCase();const co=(r['Company']||'').trim();const sp=/^[a-z]{3,}\.[a-z]{1,3}@northeastern\.edu$/;const st=/^[a-z]{1,3}\.[a-z]{3,}@northeastern\.edu$/;let cat='Other';let meth='';if(sp.test(em)){cat='Roux Student';meth='Student email pattern'}else if(st.test(em)){cat='Northeastern/Roux Staff';meth='Staff email pattern'}else{const d=em.includes('@')?em.split('@')[1]:'';const l=co.toLowerCase();if(pers.includes(d)&&(l==='student'||l.includes('student')||l.includes('northeastern')||l.includes('roux'))){cat='Roux Student';meth='Personal email + Company'}else if(em.includes('northeastern.edu')){cat='Northeastern/Roux Staff';meth='Northeastern email (other)'}else if(l.includes('town of')||l.includes('city of')||em.includes('.gov')){cat='Government';meth='Gov domain/company'}}csv+=`"${nm}","${em}","${co}","${cat}","${meth}"\n`});const b=new Blob([csv],{type:'text/csv'});const u=URL.createObjectURL(b);const a=document.createElement('a');a.href=u;a.download='attendee-categorization-debug.csv';a.click();URL.revokeObjectURL(u);alert('Categorization debug exported!')}function exportCompanyDebug(){if(rawData.length===0)return;const pers=['gmail.com','yahoo.com','outlook.com','hotmail.com','icloud.com','me.com','aol.com','mail.com'];const excl=['retired','independent','na','n/a','self','?','none','student'];const doms={};rawData.forEach(r=>{const em=(r['Buyer email']||r['Email']||'').trim().toLowerCase();if(em&&em.includes('@')){const d=em.split('@')[1];if(d&&d!=='northeastern.edu'&&!pers.includes(d)&&!d.includes('u.northeastern')&&d.split('.').length>=2&&d.length>5){doms[d]=d}}});function norm(n){if(!n)return null;let cl=n.toLowerCase().replace(/\s+/g,'').replace(/[,\.\'\"]/g,'').replace(/\b(llc|inc|ltd|co|corp|corporation|company|group|the)\b/g,'').trim();for(let d of Object.keys(doms)){const b=d.split('.')[0];if(cl===b)return d;if(b.length>=4&&cl.length>=4){const cv=[cl,cl+'s',cl.replace(/s$/,'')];const bv=[b,b+'s',b.replace(/s$/,'')];for(let c of cv){for(let v of bv){if(c===v&&c.length>=4)return d}}}}return n.toLowerCase()}const comps={};rawData.forEach(r=>{const em=(r['Buyer email']||r['Email']||'').trim().toLowerCase();const co=(r['Company']||'').trim();const low=co.toLowerCase();const nm=`${r['First name']||''} ${r['Last name']||''}`.trim();let id=null;let src='';if(!em||!em.includes('@')){if(co&&!excl.includes(low)&&!low.includes('northeastern')&&!low.includes('roux')&&!low.includes('student')){id=norm(co);src='Company (no email) - normalized'}}else{const d=em.split('@')[1];if(d==='northeastern.edu'||d.includes('u.northeastern'))return;if(pers.includes(d)){if(co&&!excl.includes(low)&&!low.includes('northeastern')&&!low.includes('roux')&&!low.includes('student')){id=norm(co);src='Company (personal email) - normalized'}}else{id=d;src='Email domain'}}if(id){if(!comps[id]){comps[id]={source:src,people:[]}}comps[id].people.push({name:nm||'N/A',email:em||'N/A',original:co})}});let csv='Normalized Company/Domain,People Count,Source Type,Sample Persons,Original Company Names\n';Object.entries(comps).sort((a,b)=>b[1].people.length-a[1].people.length).forEach(([id,d])=>{const samp=d.people.slice(0,3).map(p=>`${p.name} (${p.email})`).join('; ');const orig=[...new Set(d.people.map(p=>p.original).filter(c=>c))].join('; ');csv+=`"${id}",${d.people.length},"${d.source}","${samp}","${orig}"\n`});const b=new Blob([csv],{type:'text/csv'});const u=URL.createObjectURL(b);const a=document.createElement('a');a.href=u;a.download='unique-companies-debug.csv';a.click();URL.revokeObjectURL(u);alert(`Exported ${Object.keys(comps).length} unique companies!`)}
    </script>
</body>
</html>
